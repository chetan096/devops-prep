pipeline {
   agent any
   tools{
      maven 'Maven3'
	    jdk 'Java'
   }
   stages {
     stage('Checkout'){
	     steps {
	      checkout scm
	     } 
     }
	 stage('Junits'){
	   steps {
	     echo 'Run unit test cases'
		 bat 'mvn -f nagp-assignment-devops/pom.xml test'
	   }
	 }
	 stage('Sonar Analysis'){
	    steps {
		   withSonarQubeEnv('Test_Sonar') {
                  bat 'mvn -f nagp-assignment-devops/pom.xml sonar:sonar'
                }
		}
	 }
	 stage('Build'){
	    steps {
		  bat 'mvn -f nagp-assignment-devops/pom.xml clean install'
		}
	 }
	 stage('Build Docker Image'){
	    steps{
		   bat 'docker build -t 3147181/nes-product:%BUILD_NUMBER% nagp-assignment-devops'
		}
	 }
	 stage('Pre Container Check'){
	    steps{
		   bat """
		    for /f %%i in ('docker ps -qf "name=^nes-product"') do set containerId=%%i
             echo %containerId%
			If "%containerId%" == "" (
				echo "No Container running"
			) ELSE (
				docker stop %ContainerId%
				docker rm -f %ContainerId%
				)
				"""
		}
	 }
	 stage('Run Docker Container'){
	    steps{
	       bat 'docker run -d -p 8082:8081 --name nes-product 3147181/nes-product:%BUILD_NUMBER%'
	    }
	 }
   }
   
   post {
      always {
	    junit nagp-assignment-devops/target/surefire-reports/*.xml
	  }
	  failure {
	    emailext attachLog: true, body: 'Build is fixed', mimeType: 'text/html', subject: 'build success', to: 'chetan.mahajan@nagarro.com'
	  }
   }
}